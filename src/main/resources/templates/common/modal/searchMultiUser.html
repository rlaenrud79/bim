
    <div class="search-box mb-20">
        <input type="text" id="mSearchText" value="" name="mSearchText" class="wid-m" placeholder="이름 또는 소속을 입력하세요." onkeydown="handleKeyPress(event, '#btnSearchUser')">
        <a href="#none" id="btnSearchUser" class="btn btn-color2"><span>검색</span></a>
    </div>
    <div class="board-top">
        <div class="txt-box">
            <p>참조자 지정은 여러명 가능합니다.</p>
        </div>
        <div class="total-num"><span th:utext="#{common.total_list_count(${searchUserDTOs.size()})}">총 <strong>100</strong>건</span></div>
    </div><!--//board-top-->

    <div class="table-wrap">
        <table class="table">
            <tbody>
            <tr>
                <th th:text="#{common.modal.search_multi_user.list_title_photo}">사진</th>
                <th th:text="#{common.modal.search_multi_user.list_title_name}">이름</th>
                <th th:text="#{common.modal.search_multi_user.list_title_company}">소속</th>
                <th th:text="#{common.modal.search_multi_user.list_title_rank}">직급</th>
                <th th:text="#{common.modal.search_multi_user.list_title_select}">선택</th>
            </tr>
            <th:block th:if="${searchUserDTOs == null or searchUserDTOs.size() == 0}">
                <tr>
                    <td colspan="5" class="no-data" th:text="#{layout.common.no_data}">등록된 데이터가 없습니다.</td>
                </tr>
            </th:block>
            <tr th:id="trTargetUser_+${item.accountDTO.userId}"
                th:each="item, index : ${searchUserDTOs}">
                <td>
                    <div th:replace="/common/userInfo :: userInfo(${item.accountDTO})"></div>
                </td>
                <td th:if="${!item.accountDTO.isRoleAdminProcess}" th:id="td_+${index.index}" class="text-center" th:text="${item.accountDTO.userName}">김기사</td>
                <td th:if="${item.accountDTO.isRoleAdminProcess}" th:id="td_+${index.index}" class="text-center" th:text="${item.accountDTO.userName} + '(' + #{common.modal.search_multi_user.role_admin_process} + ')'">김기사</td>
                <td class="text-center"><small><span th:text="${item.accountDTO.companyRoleName}">발주사</span> / <span th:text="${item.accountDTO.companyName}">한국 발주</span></small></td>
                <td class="text-center" th:text="${item.accountDTO.rank}">과장</td>
                <td><a href="#" th:id="mBtnMultiSelect_+${index.index}"
                       th:data-id="${item.accountDTO.userId}"
                       th:data-name="${item.accountDTO.userName}" class="btn-toggle" th:classappend=" ${item.isSelected} ? 'on' : ''"></a></td>
                <td style="display: none;" th:text="${item.accountDTO.companyName}"></td>
                <td style="display: none;" th:text="${item.accountDTO.accountRoles}"></td>
                <td style="display: none;" th:text="${item.isSearchResult}"></td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="btn-box btn-bottom-sticky">
        <a href="#none" id="mBtnConfirm" class="btn btn-color1">저장</a>
        <a href="#none" class="btn btn-close">취소</a>
    </div>


    <script>
        var setSelectedUser = function () {
            let selectedUserCnt = 0;
            let fixId = "[[${fixId}]]";
            let selectedUserId = fixId;

            $("a[id^='mBtnMultiSelect_']").each(function (index, item) {
                let userIdArray = fixId.split(',');
                let indexToRemove = userIdArray.indexOf($(item).data("id").toString());
                if ($(item).hasClass("on")) {
                    if (fixId != "") {
                        if (indexToRemove !== -1) {
                        } else {
                            if (selectedUserCnt === 0) {
                                if (selectedUserId != null && selectedUserId !== "") selectedUserId += ",";
                                selectedUserId += $(item).data("id");
                            } else {
                                selectedUserId += "," + $(item).data("id");
                            }
                        }
                    } else {
                        if (selectedUserCnt === 0) {
                            if (selectedUserId != null && selectedUserId !== "") selectedUserId += ",";
                            selectedUserId += $(item).data("id");
                        } else {
                            selectedUserId += "," + $(item).data("id");
                        }
                    }
                    ++selectedUserCnt;
                } else {
                    let userIdArray = selectedUserId.split(',');

                    let indexToRemove = userIdArray.indexOf($(item).data("id").toString());
                    if (indexToRemove !== -1) {
                        userIdArray.splice(indexToRemove, 1);
                    }

                    selectedUserId = userIdArray.join(',');
                }
            });

            if (selectedUserCnt === 0) {
                alert("[[#{common.modal.search_multi_user.error_no_select_user_cnt}]]");
                return false;
            }

            if ('' != '[[${formElementIdForUserIds}]]') $("#" + "[[${formElementIdForUserIds}]]").val(selectedUserId);
            //if ('' != '[[${formElementIdForModal}]]') $("#" + "[[${formElementIdForModal}]]").modal("hide");
            if ('' != '[[${formElementIdForModal}]]') $this.find('.close-btn').click();
            getUserInfoAtField(selectedUserId);

            return true;
        }

        $(document).ready(function () {

            const $this = $("#[[${formElementIdForModal}]]");
            const _checkedSearchCondition = "[[${checkedSearchCondition}]]";

            function getSearchCondition() {
                let isSearchRoleAdminProject = $("input:checkbox[id='isSearchRoleAdminProject']").is(":checked");
                let isSearchRoleAdminWork = $("input:checkbox[id='isSearchRoleAdminWork']").is(":checked");
                let searchUserType = $("#searchUserType").val();
                let searchText = $("#searchText").val();
                return {isSearchRoleAdminProject, isSearchRoleAdminWork, searchUserType, searchText};
            }

            function hideSearchList() {
                $("tr[id^='trTargetUser_']").hide();
            }

            function executeSearch(isSearchRoleAdminProject, isSearchRoleAdminWork, searchUserType, searchText) {
                $("tr[id^='trTargetUser_']").each(function (i) {

                    let td = $(this).children();
                    /*
                    td.eq(1).text(): 이름
                    td.eq(5).text(): 회사명
                    td.eq(6).text(): 권한 (예: 'ROLE_ADMIN_PROJECT,ROLE_ADMIN_WORK,ROLE_USER_NORMAL,')
                    td.eq(7).text(): FALSE 또는 TRUE (item.isSearchResult)
                     */
                    if (isSearchRoleAdminProject === true && isSearchRoleAdminWork === true && searchUserType === "USER_NAME") {
                        if (td.eq(1).text().includes(searchText)
                            && (td.eq(6).text().includes("ROLE_ADMIN_PROJECT") || td.eq(6).text().includes("ROLE_ADMIN_WORK"))
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === true && isSearchRoleAdminWork === false && searchUserType === "USER_NAME") {
                        if (td.eq(1).text().includes(searchText)
                            && td.eq(6).text().includes("ROLE_ADMIN_PROJECT")
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === false && isSearchRoleAdminWork === true && searchUserType === "USER_NAME") {
                        if (td.eq(1).text().includes(searchText)
                            && td.eq(6).text().includes("ROLE_ADMIN_WORK")
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === false && isSearchRoleAdminWork === false && searchUserType === "USER_NAME") {
                        if (td.eq(1).text().includes(searchText)
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === true && isSearchRoleAdminWork === true && searchUserType === "COMPANY_NAME") {
                        if (td.eq(5).text().includes(searchText)
                            && (td.eq(6).text().includes("ROLE_ADMIN_PROJECT") || td.eq(6).text().includes("ROLE_ADMIN_WORK"))
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === true && isSearchRoleAdminWork === false && searchUserType === "COMPANY_NAME") {
                        if (td.eq(5).text().includes(searchText)
                            && td.eq(6).text().includes("ROLE_ADMIN_PROJECT")
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === false && isSearchRoleAdminWork === true && searchUserType === "COMPANY_NAME") {
                        if (td.eq(5).text().includes(searchText)
                            && td.eq(6).text().includes("ROLE_ADMIN_WORK")
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                    if (isSearchRoleAdminProject === false && isSearchRoleAdminWork === false && searchUserType === "COMPANY_NAME") {
                        if (td.eq(5).text().includes(searchText)
                            //&& td.eq(7).text().includes("TRUE"))
                        )$(this).show();
                    }
                });
            }

            let init = function(){
                if(_checkedSearchCondition === "true") {
                    hideSearchList();
                    executeSearch(true, true, "USER_NAME", "");
                }
            }

            $this.find("#isSearchRoleAdminProject, #isSearchRoleAdminWork").on("click", function () {
                let {isSearchRoleAdminProject, isSearchRoleAdminWork, searchUserType, searchText} = getSearchCondition();
                hideSearchList();
                executeSearch(isSearchRoleAdminProject, isSearchRoleAdminWork, searchUserType, searchText);
            });

            $this.find("#searchText").on('keyup', function () {
                let {isSearchRoleAdminProject, isSearchRoleAdminWork, searchUserType, searchText} = getSearchCondition();

                if (searchText.length < 2) {
                    $("tr[id^='trTargetUser_']").show();
                    return;
                }

                hideSearchList();
                executeSearch(isSearchRoleAdminProject, isSearchRoleAdminWork, searchUserType, searchText);
            });

            $this.find('a[id^=\'mBtnMultiSelect_\']').on('click', function (e) {
                console.log("test---------------------");
                $(this).toggleClass("on");
                //if ('' != '[[${formElementIdForUserId}]]') $("#[[${formElementIdForUserId}]]").val($(this).attr("data-id"));
                //if ('' != '[[${formElementIdForUserName}]]') $("#[[${formElementIdForUserName}]]").val($(this).attr("data-name"));
                //if ('' != '[[${formElementIdForModal}]]') $this.find('.close-btn').click();
            });

            $this.find('.btn-close').on('click', function () {
                $(".close").click();
            });

            $this.find("#mBtnConfirm").on('click', function () {
                setSelectedUser();
            });

            $this.find('#btnSearchUser').on('click', function () {
                let param = `formElementIdForUserId=[[${formElementIdForUserId}]]`;
                param += `&formElementIdForModal=[[${formElementIdForModal}]]`;
                param += `&formElementIdForUserIds=[[${formElementIdForUserIds}]]`;
                param += `&searchUserFilter=Y`;
                param += `&referenceSelected=N`;
                param += `&searchText=${$("#mSearchText").val()}`;
                param += `&fixId=[[${fixId}]]`;
                const params = {};

                const callback = function (data) {
                    $('#taskRefereePopup').find('.popup-con').html(data);
                    $('#taskRefereePopup').show();
                };

                $.nfx.ajaxGet(params, 'html', callback, `/commonModal/searchMultiUserText?${param}`);
            });

            init();

        });
    </script>